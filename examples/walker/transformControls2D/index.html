<!DOCTYPE html>
<html lang="en">
<head>
    <title>index</title>
</head>
<body>

<div>
    <button onclick="test()">test</button>
    <button onclick="transform()">transform</button>
</div>


<div id="WebGL-output"> </div>

<script src="../../../build/three.js"></script>

<script src="../../js/libs/dat.gui.min.js"></script>
<script src="./IntersectDetector.js"></script>
<script src="./TransformControls2D.js"></script>
<script src="./MSRControls.js"></script>

<script>

    var scene, camera, renderer, group;
    var transformControl;
    var plane;

    init();

    addGrid();
    addImage();

    addTransformControls();
    addIntersectDetector();
    addMSRControls();
    animate();


    function init() {
        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 1000 );
        camera.position.set( 0, 0, 450 );
        camera.lookAt( new THREE.Vector3( 0, 0, 0 ) );

        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setClearColor( new THREE.Color( 0xE8E8E8 ), 1.0 );
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.shadowMapEnabled = true;

        scene.add( camera );

        document.getElementById( "WebGL-output" ).appendChild( renderer.domElement );

        group = new THREE.Group();
        // modelGroup.scale.set(2,2,2);
        modelGroup = new THREE.Group();
        // modelGroup.scale.set(2,2,2);
        // modelGroup.rotateZ(Math.PI/6);
        scene.add( group );
        group.add(modelGroup);
    }

    function addGrid() {
        var gridHelper = new THREE.GridHelper( 400, 40, 0x0000ff, 0x808080 );
        gridHelper.rotation.x = Math.PI/2;
        scene.add( gridHelper );
    }
    function addImage() {
        const geometry = new THREE.PlaneGeometry(80, 142);
        const texture = new THREE.TextureLoader().load('./kobe.png' );
        const material = new THREE.MeshBasicMaterial({
            map: texture,
            side: THREE.DoubleSide,
            opacity: 0.75,
            transparent: true
        });
        const object3D = new THREE.Mesh(geometry, material);
        modelGroup.add( object3D );
    }

    function addIntersectDetector() {
        // only detect 'modelGroup.children'
        this.intersectDetector = new THREE.IntersectDetector(
            modelGroup.children,
            camera,
            renderer.domElement
        );
        // triggered when "left mouse down on model"
        this.intersectDetector.addEventListener(
            'detected',
            function(event) {
                const modelMesh = event.object;
                transformControl.attach(modelMesh);
            }
        );
    }

    function addTransformControls() {
        transformControl = new THREE.TransformControls2D( camera, renderer.domElement, scene );
        // transformControl.addEventListener( 'change', render );
        // transformControl.addEventListener('mouseUp', updateModelInfo_Size );
        scene.add( transformControl );
    }
    function animate() {
        requestAnimationFrame( animate );
        render();
    }

    function render() {
        renderer.render( scene, camera );
    }

    function addMSRControls() {
        msrControls = new THREE.MSRControls(group, camera, renderer.domElement);
        msrControls.enabledRotate = false;
        // triggered first, when "mouse down on canvas"
        msrControls.addEventListener(
            'mouseDown',
            function () {
            }
        );
        // targeted in last, when "mouse up on canvas"
        msrControls.addEventListener(
            'moveStart',
            function () {
            }
        );
        // triggered last, when "mouse up on canvas"
        msrControls.addEventListener(
            'mouseUp',
            function () {
            }
        )
    }

    function test() {
        // document.style.cursor = 'pointer';
        // document.style.cursor = 'crosshair';
        transformControl.detach();
    }
    function transform() {
        if (transformControl.object) {
            transformControl.object.position.add(new THREE.Vector3(1, 2, 0));
            transformControl.object.rotateZ(0.1);
        }
    }
</script>

</body>
</html>
